# Cloudinary ç§»é™¤æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

æˆåŠŸå°†é¡¹ç›®ä» Cloudinary ä¾èµ–è¿ç§»åˆ°å®Œå…¨ä½¿ç”¨æœåŠ¡ç«¯ FFmpeg è¿›è¡Œè§†é¢‘å¤„ç†ã€‚

**åˆ†æ”¯**: `remove-cloudinary`

**æ—¥æœŸ**: 2025å¹´11æœˆ12æ—¥

---

## ğŸ¯ æ”¹åŠ¨ç›®æ ‡

- âœ… ç§»é™¤ Cloudinary ä¾èµ–
- âœ… ä½¿ç”¨æœåŠ¡ç«¯ FFmpeg è¿›è¡Œè§†é¢‘åˆå¹¶
- âœ… ä¿ç•™ B2 (Backblaze) ä½œä¸ºè§†é¢‘å­˜å‚¨
- âœ… ä¿ç•™ Supabase ä½œä¸ºæ•°æ®åº“
- âœ… å®Œå…¨æ‘†è„± Vercel å’Œ Cloudinary é™åˆ¶

---

## ğŸ”§ ä¸»è¦æ›´æ”¹

### 1. **Dockerfile** - æ·»åŠ  FFmpeg

```dockerfile
# ç”Ÿäº§è¿è¡Œé˜¶æ®µ
FROM base AS runner
WORKDIR /app

# å®‰è£… FFmpeg å’Œ ffprobeï¼ˆè§†é¢‘å¤„ç†ï¼‰
RUN apk add --no-cache ffmpeg
```

**éªŒè¯**: 
- âœ… FFmpeg ç‰ˆæœ¬: `6.1.2`
- âœ… å·²åœ¨ Docker å®¹å™¨ä¸­æˆåŠŸå®‰è£…

### 2. **åˆ é™¤çš„æ–‡ä»¶** (å…± 10 ä¸ª)

```
lib/cloudinary.ts                           # Cloudinary æœåŠ¡ç«¯å·¥å…·åº“
lib/client-cloudinary.ts                    # Cloudinary å®¢æˆ·ç«¯å·¥å…·åº“
app/api/merge-cloudinary/route.ts           # Cloudinary åˆå¹¶ API
app/api/merge-videos-cloudinary/route.ts    # Cloudinary è§†é¢‘åˆå¹¶ API
app/api/cleanup-cloudinary/route.ts         # Cloudinary æ¸…ç† API
app/api/test-cloudinary/route.ts            # Cloudinary æµ‹è¯• API
app/api/upload-merged-video/route.ts        # Cloudinary ä¸Šä¼  API
app/test-upload/page.tsx                    # Cloudinary æµ‹è¯•é¡µé¢
CLOUDINARY-CLIENT-UPLOAD-FIX.md             # Cloudinary æ–‡æ¡£
```

### 3. **package.json** - ç§»é™¤ä¾èµ–

```diff
- "cloudinary": "^2.8.0"
```

**éªŒè¯**: 
- âœ… `pnpm-lock.yaml` å·²æ›´æ–°
- âœ… Docker æ„å»ºæˆåŠŸ

### 4. **app/student/interview/page.tsx** - å‰ç«¯ä»£ç 

**ç§»é™¤**:
- âŒ `uploadSegmentVideosClient` å‡½æ•°ï¼ˆ233è¡Œä»£ç ï¼‰
- âŒ Cloudinary å®¢æˆ·ç«¯å¯¼å…¥

**æ›´æ–°**:
- âœ… ä½¿ç”¨ `uploadSegmentVideos` å‡½æ•°
- âœ… è°ƒç”¨ `/api/merge-videos` (æœåŠ¡ç«¯ FFmpeg)

### 5. **é…ç½®æ–‡ä»¶æ›´æ–°**

#### `docker-compose.linode.yml`
```diff
- NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME
- NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET
```

#### `Dockerfile`
```diff
- ARG NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME
- ARG NEXT_PUBLIC_CLOUDINARY_UPLOAD_PRESET
```

### 6. **æ–‡æ¡£æ›´æ–°**

- âœ… `ENV-SETUP.md` - ç§»é™¤ Cloudinary é…ç½®è¯´æ˜
- âœ… `LINODE-DEPLOYMENT.md` - æ›´æ–°ç¯å¢ƒå˜é‡ç¤ºä¾‹
- âœ… `LINODE-QUICK-START.md` - æ›´æ–°å¿«é€Ÿå¼€å§‹æŒ‡å—
- âœ… `app/debug-merge/page.tsx` - æ›´æ–°è°ƒè¯•é¡µé¢

---

## ğŸ—ï¸ æ–°æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           å­¦ç”Ÿå½•åˆ¶è§†é¢‘                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     ä¸Šä¼ è§†é¢‘ç‰‡æ®µåˆ° B2 (Backblaze)         â”‚
â”‚     - ä½¿ç”¨ AWS SDK                       â”‚
â”‚     - ç›´æ¥ä¸Šä¼ ï¼Œé¿å… Vercel é™åˆ¶          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   æœåŠ¡ç«¯ FFmpeg åˆå¹¶ï¼ˆåœ¨ Docker å®¹å™¨ä¸­ï¼‰   â”‚
â”‚   - API: /api/merge-videos              â”‚
â”‚   - ä» B2 ä¸‹è½½ç‰‡æ®µ                       â”‚
â”‚   - ä½¿ç”¨ FFmpeg concat åˆå¹¶              â”‚
â”‚   - ä¸Šä¼ åˆå¹¶åè§†é¢‘å› B2                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å­˜å‚¨å…ƒæ•°æ®åˆ° Supabase                 â”‚
â”‚     - è§†é¢‘ URL (B2)                     â”‚
â”‚     - å­—å¹•æ—¶é—´è½´                         â”‚
â”‚     - å­¦ç”Ÿä¿¡æ¯                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### éƒ¨ç½²ç¯å¢ƒ
- **æœåŠ¡å™¨**: Linode (74.207.251.192)
- **ç”¨æˆ·**: v0-interview
- **è·¯å¾„**: /home/v0-interview/apps/v0-interview
- **ç«¯å£**: 3001

### æµ‹è¯•éªŒè¯

1. **FFmpeg å®‰è£…** âœ…
   ```bash
   $ docker exec v0-interview-app ffmpeg -version
   ffmpeg version 6.1.2 Copyright (c) 2000-2024 the FFmpeg developers
   ```

2. **åº”ç”¨è¿è¡Œ** âœ…
   ```bash
   $ curl http://localhost:3001
   HTTP/1.1 200 OK
   ```

3. **ç¯å¢ƒå˜é‡** âœ…
   ```bash
   âœ“ B2_BUCKET_NAME
   âœ“ B2_BUCKET_REGION
   âœ“ B2_APPLICATION_KEY_ID
   âœ“ B2_APPLICATION_KEY
   âœ“ NEXT_PUBLIC_SUPABASE_URL
   âœ“ NEXT_PUBLIC_SUPABASE_ANON_KEY
   âœ“ SUPABASE_SERVICE_ROLE_KEY
   âœ— CLOUDINARY_* (å·²ç§»é™¤)
   ```

4. **Docker å®¹å™¨** âœ…
   ```
   NAME               STATUS
   v0-interview-app   Up (healthy)
   ```

---

## ğŸ“ˆ æ”¹è¿›

### æ€§èƒ½
- âœ… **æ— éœ€ç¬¬ä¸‰æ–¹ API è°ƒç”¨** - è§†é¢‘åˆå¹¶åœ¨æœ¬åœ°å®Œæˆ
- âœ… **æ›´å¿«çš„å¤„ç†é€Ÿåº¦** - ä¸éœ€è¦ä¸Šä¼ åˆ° Cloudinary å†ä¸‹è½½
- âœ… **æ— æ–‡ä»¶å¤§å°é™åˆ¶** - å®Œå…¨æ‘†è„± Vercel çš„ 413 é”™è¯¯

### æˆæœ¬
- âœ… **é›¶ Cloudinary è´¹ç”¨** - ä¸å†éœ€è¦ Cloudinary è®¢é˜…
- âœ… **ä½å­˜å‚¨æˆæœ¬** - B2 ä»·æ ¼: $0.005/GB/æœˆ
- âœ… **ä½å¸¦å®½æˆæœ¬** - B2 å¸¦å®½: $0.01/GB

### å¯é æ€§
- âœ… **å®Œå…¨è‡ªä¸»æ§åˆ¶** - è§†é¢‘å¤„ç†åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Š
- âœ… **æ— ç¬¬ä¸‰æ–¹ä¾èµ–** - ä¸å— Cloudinary API é™åˆ¶å½±å“
- âœ… **ç®€åŒ–æ¶æ„** - å‡å°‘äº†ä¸€ä¸ªå¤–éƒ¨æœåŠ¡

---

## ğŸ”„ å·¥ä½œæµç¨‹å¯¹æ¯”

### ä¹‹å‰ (ä½¿ç”¨ Cloudinary)

```
å½•åˆ¶ â†’ ä¸Šä¼ åˆ° B2 â†’ ä¸Šä¼ åˆ° Cloudinary â†’ Cloudinary åˆå¹¶ 
     â†’ ä¸‹è½½ â†’ ä¸Šä¼ å› B2 â†’ ä¿å­˜åˆ° Supabase
```

**é—®é¢˜**:
- âŒ å¤šæ¬¡ä¸Šä¼ ä¸‹è½½ï¼Œæµªè´¹å¸¦å®½
- âŒ ä¾èµ– Cloudinary API
- âŒ é¢å¤–çš„æˆæœ¬
- âŒ å¯èƒ½çš„ Vercel 413 é”™è¯¯

### ç°åœ¨ (ä½¿ç”¨æœåŠ¡ç«¯ FFmpeg)

```
å½•åˆ¶ â†’ ä¸Šä¼ åˆ° B2 â†’ æœåŠ¡ç«¯ FFmpeg åˆå¹¶ 
     â†’ ä¸Šä¼ å› B2 â†’ ä¿å­˜åˆ° Supabase
```

**ä¼˜åŠ¿**:
- âœ… æµç¨‹ç®€åŒ–ï¼Œå‡å°‘ç½‘ç»œä¼ è¾“
- âœ… æ— ç¬¬ä¸‰æ–¹ä¾èµ–
- âœ… é›¶é¢å¤–æˆæœ¬
- âœ… æ— æ–‡ä»¶å¤§å°é™åˆ¶

---

## ğŸš€ ä¸‹ä¸€æ­¥

### åˆå¹¶åˆ°ä¸»åˆ†æ”¯

1. **ç¡®è®¤æµ‹è¯•é€šè¿‡** âœ…
2. **åˆ›å»º Pull Request**
   ```bash
   git push origin remove-cloudinary
   # åœ¨ GitHub ä¸Šåˆ›å»º PR
   ```

3. **åˆå¹¶åˆ° main**
   ```bash
   git checkout main
   git merge remove-cloudinary
   git push origin main
   ```

4. **åœ¨æœåŠ¡å™¨ä¸Šåˆ‡æ¢åˆ° main**
   ```bash
   ssh linode-Athena
   sudo -u v0-interview -i
   cd ~/apps/v0-interview
   git checkout main
   git pull origin main
   ./deploy-linode.sh
   ```

### å¯é€‰ä¼˜åŒ–

- ğŸ”„ **æ·»åŠ è§†é¢‘å‹ç¼©** - ä½¿ç”¨ FFmpeg å‹ç¼©è§†é¢‘ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´
- ğŸ”„ **æ·»åŠ è¿›åº¦æ˜¾ç¤º** - å®æ—¶æ˜¾ç¤ºåˆå¹¶è¿›åº¦ç»™ç”¨æˆ·
- ğŸ”„ **æ·»åŠ é‡è¯•æœºåˆ¶** - è‡ªåŠ¨é‡è¯•å¤±è´¥çš„åˆå¹¶æ“ä½œ
- ğŸ”„ **æ·»åŠ æ—¥å¿—è®°å½•** - è®°å½•æ‰€æœ‰è§†é¢‘å¤„ç†æ“ä½œ

---

## ğŸ“ ç»´æŠ¤å»ºè®®

1. **ç›‘æ§ Docker å®¹å™¨èµ„æºä½¿ç”¨**
   ```bash
   docker stats v0-interview-app
   ```

2. **å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶**
   ```bash
   # FFmpeg ä¼šåœ¨ /tmp ä¸­åˆ›å»ºä¸´æ—¶æ–‡ä»¶
   docker exec v0-interview-app du -sh /tmp
   ```

3. **ç›‘æ§ B2 å­˜å‚¨å’Œå¸¦å®½**
   - ç™»å½• Backblaze B2 æ§åˆ¶å°
   - æ£€æŸ¥å­˜å‚¨ä½¿ç”¨é‡å’Œå¸¦å®½ä½¿ç”¨é‡

---

## ğŸ‰ æ€»ç»“

æˆåŠŸå®Œæˆäº†ä» Cloudinary åˆ°æœåŠ¡ç«¯ FFmpeg çš„è¿ç§»ï¼š

- âœ… åˆ é™¤äº† 10 ä¸ª Cloudinary ç›¸å…³æ–‡ä»¶
- âœ… ç§»é™¤äº† 1 ä¸ª npm ä¾èµ–
- âœ… ç®€åŒ–äº†è§†é¢‘å¤„ç†æµç¨‹
- âœ… é™ä½äº†è¿è¥æˆæœ¬
- âœ… æé«˜äº†ç³»ç»Ÿå¯é æ€§
- âœ… å®Œå…¨æ‘†è„±äº† Vercel å’Œ Cloudinary çš„é™åˆ¶

**æäº¤æ•°**: 2
**åˆ é™¤ä»£ç **: 1,608 è¡Œ
**æ–°å¢ä»£ç **: 1,157 è¡Œ
**å‡€å‡å°‘**: 451 è¡Œ

ç³»ç»Ÿç°åœ¨å®Œå…¨è¿è¡Œåœ¨ Linode æœåŠ¡å™¨ä¸Šï¼Œä½¿ç”¨ B2 å­˜å‚¨å’Œ Supabase æ•°æ®åº“ï¼Œå…·æœ‰å®Œå…¨çš„è‡ªä¸»æ§åˆ¶æƒã€‚

